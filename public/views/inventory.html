<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Items</title>
    <link rel="stylesheet" href="/css/homePage.css">
    <link rel="stylesheet" href="/css/itemSorter.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Collapsible Sidebar -->
        <main class="main-content">
            <header>
                <h1>Corporate IT Solutions - Inventory</h1>
                <div class="user-info">
                    <span>Welcome, <strong id="usernameDisplay">Admin</strong></span>
                    <span id="cityDisplay"><i class="fas fa-map-marker-alt"></i> Lusaka</span>
                </div>
            </header>

            <div class="content-section">
                <div class="table-and-slideshow-container">
                    <div class="tables-container">
                        <div class="table-container">
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Discount</th>
                                        <th>Unit Price</th>
                                        <th>Line Total</th>
                                    </tr>
                                </thead>
                                <tbody id="live-inventory-body">
                                    
                                </tbody>
                            </table>
                        </div>
                        <div class="table-container">
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>Total Items</th>
                                        <th>Total Discount</th>
                                        <th>Total Price</th>
                                    </tr>
                                </thead>
                                <tbody id="live-totals-table">
                                    <!-- Totals will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <aside class="image-slideshow">
                        <div class="slideshow-container" id="slideshow">
                            <!-- Slides will be loaded via JavaScript -->
                        </div>
                        <div class="slideshow-nav" id="slideshow-nav">
                            <!-- Dots will be loaded via JavaScript -->
                        </div>
                        
                        <!-- VIDEO CONTAINER ADDED HERE -->
                        <div class="video-container">
                            <video id="featuredVideo" controls>
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </aside>
                </div>
            </div>

            <footer>
                <h1>Welcome to Corporate IT Solutions</h1>
            </footer>
        </main>
    </div>    

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load user data
            const username = sessionStorage.getItem('username') || 'Admin';
            const city = sessionStorage.getItem('city') || 'Lusaka';
            document.getElementById('usernameDisplay').textContent = username;
            document.getElementById('cityDisplay').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${city}`;

            // Load inventory data from API
            fetchInventoryData();
            
            // Load slideshow images and video from database
            fetchMedia();
        });

        async function fetchInventoryData() {
            try {
                const response = await fetch('/inventory/api');
                
                if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.items || !Array.isArray(data.items)) {
                throw new Error('Invalid data format received from server');
                }
                
                renderInventory(data.items, data.totals || {});
                
            } catch (error) {
                console.error('Fetch Error:', error);
                alert(`Failed to load inventory: ${error.message}\nCheck console for details.`);
                // Show empty state
                renderInventory([], { total_items: 0, total_discount: 0, total_price: 0 });
            }
        }

        async function fetchMedia() {
            try {
                const response = await fetch('/upload/media');
                if (!response.ok) {
                    throw new Error('Failed to fetch media');
                }
                const data = await response.json();
                
                if (data.success && data.media) {
                    // Separate images and videos from all users
                    const images = data.media.filter(item => 
                        item.file_type.startsWith('image/')
                    );
                    
                    const videos = data.media.filter(item => 
                        item.file_type.startsWith('video/')
                    );
                    
                    // Initialize slideshow with all images
                    if (images.length > 0) {
                        initSlideshow(images);
                    } else {
                        // Fallback to default images
                        initSlideshow([
                            { id: 'default1', file_path: '/images/slide1.jpg', file_name: 'Default Image 1' },
                            { id: 'default2', file_path: '/images/slide2.jpg', file_name: 'Default Image 2' },
                            { id: 'default3', file_path: '/images/slide3.jpg', file_name: 'Default Image 3' }
                        ], true);
                    }
                    
                    // Initialize video player with ALL videos from all users
                    if (videos.length > 0) {
                        initVideoPlayer(videos);
                    } else {
                        // Fallback to default video
                        initVideoPlayer([{
                            file_path: '/videos/demo.mp4',
                            file_name: 'Demo Video'
                        }]);
                    }
                } else {
                    console.error('Invalid data structure from media API');
                    // Fallback to default media
                    initSlideshow([
                        { id: 'default1', file_path: '/images/slide1.jpg', file_name: 'Default Image 1' },
                        { id: 'default2', file_path: '/images/slide2.jpg', file_name: 'Default Image 2' },
                        { id: 'default3', file_path: '/images/slide3.jpg', file_name: 'Default Image 3' }
                    ], true);
                    
                    initVideoPlayer([{
                        file_path: '/videos/demo.mp4',
                        file_name: 'Demo Video'
                    }]);
                }
            } catch (error) {
                console.error('Error fetching media:', error);
                // Fallback to default media
                initSlideshow([
                    { id: 'default1', file_path: '/images/slide1.jpg', file_name: 'Default Image 1' },
                    { id: 'default2', file_path: '/images/slide2.jpg', file_name: 'Default Image 2' },
                    { id: 'default3', file_path: '/images/slide3.jpg', file_name: 'Default Image 3' }
                ], true);
                
                initVideoPlayer([{
                    file_path: '/videos/demo.mp4',
                    file_name: 'Demo Video'
                }]);
            }
        }
        
        function initVideoPlayer(videos) {
            const videoContainer = document.querySelector('.video-container');
            const videoPlayer = document.getElementById('featuredVideo');
            const videoNav = document.createElement('div');
            videoNav.className = 'video-nav';
            videoContainer.appendChild(videoNav);

            let currentVideoIndex = 0;
            
            // Create navigation dots for videos
            videoNav.innerHTML = videos.map((_, index) => `
                <span class="video-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>
            `).join('');

            const videoDots = document.querySelectorAll('.video-dot');
            
            // Function to play a specific video
            function playVideo(index) {
                if (index >= videos.length) index = 0;
                if (index < 0) index = videos.length - 1;
                
                currentVideoIndex = index;
                const video = videos[index];
                
                videoPlayer.src = video.file_path;
                videoPlayer.load();
                videoPlayer.setAttribute('title', video.file_name);
                
                // Update active dot
                videoDots.forEach(dot => dot.classList.remove('active'));
                videoDots[index].classList.add('active');
                
                videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
            }

            // When video ends, play next one
            videoPlayer.addEventListener('ended', () => {
                playVideo(currentVideoIndex + 1);
            });

            // Dot navigation for videos
            videoDots.forEach(dot => {
                dot.addEventListener('click', function() {
                    const videoIndex = parseInt(this.getAttribute('data-index'));
                    playVideo(videoIndex);
                });
            });

            // Start with first video
            if (videos.length > 0) {
                playVideo(0);
            }
        }

        function renderInventory(items, totals) {
            const itemsBody = document.getElementById('live-inventory-body');
            const totalsBody = document.getElementById('live-totals-table');
            
            // Clear previous content
            itemsBody.innerHTML = '';
            totalsBody.innerHTML = '';

            // Helper function to safely format numbers
            const formatNumber = (value) => {
                const num = Number(value) || 0;
                return num.toFixed(2);
            };

            // Render items
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${item.VC_ITEM_DESC || 'N/A'}</td>
                <td>${item.NU_QTY || 0}</td>
                <td>${formatNumber(item.NU_DISCOUNT)}%</td>
                <td>$${formatNumber(item.NU_ITEM_PRICE)}</td>
                <td>$${formatNumber(item.NU_LINE_TOTAL)}</td>
                `;
                itemsBody.appendChild(row);
            });

            // Render totals
            const totalsRow = document.createElement('tr');
            totalsRow.innerHTML = `
                <td>${totals.total_items || 0}</td>
                <td>$${formatNumber(totals.total_discount)}</td>
                <td>$${formatNumber(totals.total_price)}</td>
            `;
            totalsBody.appendChild(totalsRow);
        }

        function initSlideshow(images) {
            const slideshow = document.getElementById('slideshow');
            slideshow.innerHTML = '';
            
            // Create container
            const container = document.createElement('div');
            container.className = 'slideshow-container';
            slideshow.appendChild(container);
            
            // Add slides
            images.forEach((img, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.innerHTML = `
                    <img src="${img.file_path}" 
                        alt="${img.file_name}"
                        onerror="this.style.display='none'">
                `;
                container.appendChild(slide);
            });
            
            // Add navigation
            const nav = document.createElement('div');
            nav.className = 'slideshow-nav';
            slideshow.appendChild(nav);
            
            // Initialize
            const slides = container.querySelectorAll('.slide');
            const totalSlides = slides.length;
            let currentIndex = 0;
            
            function showSlide(index) {
                slides.forEach(slide => slide.classList.remove('active'));
                slides[index].classList.add('active');
                currentIndex = index;
            }
            
            function nextSlide() {
                const nextIndex = (currentIndex + 1) % totalSlides;
                showSlide(nextIndex);
            }
            
            // Start slideshow
            showSlide(0);
            const interval = setInterval(nextSlide, 2000);
            
            // Cleanup on destroy
            return () => clearInterval(interval);
        }
    </script>
</body>
</html>